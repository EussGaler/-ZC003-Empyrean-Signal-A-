# **[ZC003]基于MSPM0G3507的方波频率测量装置**

ZC003--自存003

---

## **1. 引脚定义**

### **1.1 spi TFT液晶LCD屏**

| IO口 | 用途 | 说明 |
| :--: | :--: | :--: |
| PB10 | RES | GPIO |
| PB11 | DC | GPIO |
| PB14 | CS | GPIO |
| PB26 | BLK | GPIO |

### **1.2 其他**

| 外设/IO口 |   用途   | 说明 |
| :--: | :------: | :--: |
| TIMG6 | 控制采样ADC0率 | 定时器 |
| DMA_CH0 | 数据转运 | ADC0 |
| PA27 | ADC输入 | ADC0 |
| PA10 | UART0串口通信 | 开发板TX |
| PA11 | UART0串口通信 | 开发板DX |
| PA14 | 开发板LED上电测试 | GPIO |

## **2.版本说明**

### **v0.2.0**

- 使用了输入捕获+测频法，0~40Hz内误差在0%
- 高频误差极大

### **v0.3.0**

- 使用了FFT

### **v0.4.0**

- 基本原理：
  - 按按键后，使用ADC高速采样2048个点，找出全部的上升沿（最多40个，触发电平约1.5V）的数组索引。`void Freq_Measure(void) //测量方波频率`

  - 计算相邻两点数组索引之差，排序后找出众数和中位数，若众数出现次数>1则采用众数，否则采用中位数。`uint16_t Result_Calculate(uint16_t *IndexDiff, uint16_t len) //计算统计结果`，输出`IndexDiff_Final`
  - 最终计算频率`Freq = (SAMPLE_FREQ / (3.0 * IndexDiff_Final)) + 0.5; //SAMPLE_FREQ = 80MHz / (LOAD_VALUE + 1)，3.0为经验值（设置的采样频率与实际采样频率可能不符），0.5为四舍五入`
- 说明：
  - 当前设置TIMG6不分频，自动重装值`LOAD_VALUE`为7，此时100 ns触发一次ADC采样（但**实际采样周期约为300 ns**，因此算频率时除3.0）。当设置采样周期为500 ns时实际采样周期也为500 ns，此时就不用除3.0。
  - 设置采样周期100 ns时实测100kHz误差1.1%，50kHz误差0.5%，32kHz误差0.15%。5kHz以下无法测量，200kHz以上误差较大。

- 下一步目标加入自适应调节采样周期。

### **v0.5.0**

- 基本原理：
  - 预设了多档自动重装值，若触发次数`TriggerCount`过少则调大自动重装值。
- 说明：
  - 经验值有时候会从3.0变成2.667。
  - 1~10kHz时几乎无误差。
  - 100kHz时误差约在1.3%以内。
  - 200kHz至1MHz误差约在10%以内。
  - 2MHz~10MHz时测量频率为1.2MHz。

- 下一步使用外部AD，即ADS8688替代ADC外设。

### **v0.5.1**

- 事实证明该方案在自动重装值较低时精确度很不稳定，只适合用来粗测。

- LCD能显示uint32_t类型的数据了。

### **v0.6.0**

- ADS8688的采样率完全不够。

### **v1.0.0**

- 使用了GPIO中断的方法，但无法准确快速识别1MHz分频出来的窄脉冲，所以方案舍弃。

### **v1.1.0**

- 换回了ADC数上升沿的方法。较为有效。

- 下一步加入自动调节分频。

## **3.注意事项**

1. 

